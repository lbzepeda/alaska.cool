---
import { getLanguageFromUrl } from '../i18n/utils';

const currentLang = getLanguageFromUrl(Astro.url);

// ✅ USANDO ARCHIVOS OPTIMIZADOS WebP/WebM YA DISPONIBLES
const projectMedia = [
  {
    id: 1,
    src: "/projects/AMPM1.webp",
    type: "image",
    alt: "Proyecto comercial AMPM - Climatización",
    title: currentLang === 'es' ? "Instalación Comercial AMPM" : "AMPM Commercial Installation",
    description: currentLang === 'es' ? 
      "Sistema de climatización comercial instalado en cadena AMPM con tecnología de última generación y eficiencia energética." :
      "Commercial HVAC system installed in AMPM chain with cutting-edge technology and energy efficiency.",
    category: currentLang === 'es' ? "Comercial" : "Commercial",
    height: "tall"
  },
  {
    id: 2,
    src: "/projects/v09044g40000d0jrptnog65g9q0lahf0.webm",
    type: "video",
    poster: "/projects/UNAN1.webp",
    alt: "Video del proceso de instalación - UNAN", 
    title: currentLang === 'es' ? "Proceso de Instalación UNAN" : "UNAN Installation Process",
    description: currentLang === 'es' ? 
      "Video detallado del proceso de instalación de sistema de climatización en Universidad Nacional Autónoma de Nicaragua." :
      "Detailed video of HVAC system installation process at National Autonomous University of Nicaragua.",
    category: currentLang === 'es' ? "Educativo" : "Educational",
    height: "tall"
  },
  {
    id: 3,
    src: "/projects/UNAN1.webp",
    type: "image",
    alt: "Universidad UNAN - Sistema de climatización",
    title: currentLang === 'es' ? "Proyecto Universitario UNAN" : "UNAN University Project",
    description: currentLang === 'es' ? 
      "Instalación completa de sistema de climatización en instalaciones universitarias con control automatizado." :
      "Complete HVAC system installation in university facilities with automated control.",
    category: currentLang === 'es' ? "Educativo" : "Educational",
    height: "medium"
  },
  {
    id: 4,
    src: "/projects/UNAN2.webp",
    type: "image",
    alt: "UNAN - Equipos de climatización instalados",
    title: currentLang === 'es' ? "Equipamiento UNAN Fase 2" : "UNAN Equipment Phase 2",
    description: currentLang === 'es' ? 
      "Segunda fase del proyecto universitario con instalación de equipos de alta eficiencia energética." :
      "Second phase of university project with high energy efficiency equipment installation.",
    category: currentLang === 'es' ? "Educativo" : "Educational",
    height: "short"
  },
  {
    id: 5,
    src: "/projects/UNAN3.webp",
    type: "image",
    alt: "UNAN - Detalles técnicos de instalación",
    title: currentLang === 'es' ? "Detalles Técnicos UNAN" : "UNAN Technical Details",
    description: currentLang === 'es' ? 
      "Vista detallada de componentes y conexiones del sistema de climatización universitario." :
      "Detailed view of university HVAC system components and connections.",
    category: currentLang === 'es' ? "Técnico" : "Technical",
    height: "tall"
  },
  {
    id: 6,
    src: "/projects/UNAN4.webp",
    type: "image",
    alt: "UNAN - Instalación completada",
    title: currentLang === 'es' ? "Finalización Proyecto UNAN" : "UNAN Project Completion",
    description: currentLang === 'es' ? 
      "Proyecto universitario completado con sistemas de monitoreo y control remoto implementados." :
      "University project completed with monitoring systems and remote control implemented.",
    category: currentLang === 'es' ? "Educativo" : "Educational",
    height: "medium"
  },
  {
    id: 7,
    src: "/projects/UNAN5.webp",
    type: "image",
    alt: "UNAN - Vista general del proyecto",
    title: currentLang === 'es' ? "Vista General UNAN" : "UNAN General View",
    description: currentLang === 'es' ? 
      "Vista panorámica del proyecto universitario mostrando la integración completa del sistema." :
      "Panoramic view of university project showing complete system integration.",
    category: currentLang === 'es' ? "Educativo" : "Educational",
    height: "tall"
  },
  {
    id: 8,
    src: "/projects/TrasCamara.webp",
    type: "image",
    alt: "Behind the scenes - Proceso de trabajo",
    title: currentLang === 'es' ? "Tras Cámaras - Proceso" : "Behind the Scenes - Process",
    description: currentLang === 'es' ? 
      "Vista tras cámaras del proceso de instalación mostrando el profesionalismo del equipo técnico." :
      "Behind the scenes view of installation process showing technical team professionalism.",
    category: currentLang === 'es' ? "Proceso" : "Process",
    height: "medium"
  },
  {
    id: 9,
    src: "/projects/v09044g40000d0lmv07og65pio5p0go0.webm",
    type: "video",
    poster: "/projects/TrasCamara.webp",
    alt: "Video técnico - Proceso de instalación",
    title: currentLang === 'es' ? "Video Técnico - Instalación" : "Technical Video - Installation",
    description: currentLang === 'es' ? 
      "Video técnico detallado mostrando metodología y técnicas profesionales de instalación." :
      "Detailed technical video showing professional installation methodology and techniques.",
    category: currentLang === 'es' ? "Técnico" : "Technical",
    height: "tall"
  },
  {
    id: 10,
    src: "/projects/v09044g40000d16s53vog65isb89cq80.webm",
    type: "video",
    poster: "/projects/AMPM1.webp",
    alt: "Video comercial - Resultado final",
    title: currentLang === 'es' ? "Video Comercial - Resultado" : "Commercial Video - Result",
    description: currentLang === 'es' ? 
      "Video promocional mostrando los resultados finales y beneficios del sistema instalado." :
      "Promotional video showing final results and benefits of installed system.",
    category: currentLang === 'es' ? "Comercial" : "Commercial",
    height: "tall"
  }
];

---

<section
  class="relative bg-neutral-50 dark:bg-gradient-to-br dark:from-neutral-900 dark:to-black text-neutral-900 dark:text-white transition-colors duration-300 py-16"
>
  <div class="max-w-[1400px] mx-auto px-4 sm:px-6">
    <div class="text-center mb-12">
      <span class="text-blue-600 dark:text-blue-400 font-medium mb-2 block">
        {currentLang === 'es' ? 'Nuestro Trabajo' : 'Our Work'}
      </span>
      <h2 class="text-3xl font-semibold text-slate-900 dark:text-white mb-4">
        {currentLang === 'es' ? 'Proyectos Realizados' : 'Completed Projects'}
      </h2>
      <p class="text-neutral-600 dark:text-neutral-400 max-w-2xl mx-auto">
        {currentLang === 'es' 
          ? 'Explora algunos de nuestros proyectos de climatización más destacados. Haz click en cualquier imagen para ver más detalles.'
          : 'Explore some of our most outstanding HVAC projects. Click on any image to see more details.'
        }
      </p>
    </div>

    <!-- Masonry Grid -->
    <div class="masonry-grid columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6">
      {projectMedia.map((media) => (
        <div 
          class={`
            group relative overflow-hidden rounded-2xl bg-white dark:bg-white/[0.02] 
            border border-neutral-200 dark:border-white/[0.1] 
            hover:shadow-2xl transition-all duration-500 cursor-pointer
            break-inside-avoid mb-6
            ${media.height === 'tall' ? 'h-96' : media.height === 'short' ? 'h-64' : 'h-80'}
          `}
          data-lightbox="projects"
          data-src={media.src}
          data-type={media.type}
          data-poster={media.poster || ''}
          data-title={media.title}
          data-description={media.description}
          data-category={media.category}
          data-id={media.id}
        >
          <div class="relative w-full h-full overflow-hidden">
            {media.type === 'video' ? (
              <div class="relative w-full h-full">
                <video
                  class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110"
                  poster={media.poster}
                  muted
                  preload="metadata"
                >
                  <source src={media.src} type="video/webm" />
                  {currentLang === 'es' ? 'Tu navegador no soporta video WebM.' : 'Your browser does not support WebM video.'}
                </video>
                <!-- Play button overlay -->
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center group-hover:bg-white/30 transition-all duration-300">
                    <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
              </div>
            ) : (
              <img
                src={media.src}
                alt={media.alt}
                class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110"
                loading="lazy"
              />
            )}
            
            <!-- Overlay gradient -->
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            
            <!-- Media type badge -->
            <div class="absolute top-3 right-3 px-2 py-1 bg-black/50 text-white text-xs font-medium rounded backdrop-blur-sm">
              {media.type === 'video' ? (
                <div class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <span>{currentLang === 'es' ? 'Video' : 'Video'}</span>
                </div>
              ) : (
                <div class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21,15 16,10 5,21"/>
                  </svg>
                  <span>{currentLang === 'es' ? 'Foto' : 'Photo'}</span>
                </div>
              )}
            </div>
            
            <!-- Category badge -->
            <div class="absolute top-3 left-3 px-3 py-1 bg-blue-600/90 text-white text-xs font-medium rounded-full backdrop-blur-sm">
              {media.category}
            </div>
            
            <!-- Content overlay -->
            <div class="absolute bottom-0 left-0 right-0 p-4 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 opacity-0 group-hover:opacity-100">
              <h3 class="text-white text-lg font-semibold mb-2 line-clamp-2">
                {media.title}
              </h3>
              <p class="text-white/90 text-sm line-clamp-2">
                {media.description}
              </p>
              
              <!-- View more button -->
              <div class="mt-3 flex items-center text-blue-300 text-sm font-medium">
                <span>{currentLang === 'es' ? (media.type === 'video' ? 'Ver video' : 'Ver detalles') : (media.type === 'video' ? 'Watch video' : 'View details')}</span>
                <svg class="w-4 h-4 ml-1 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox-modal" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <!-- Close button -->
      <button 
        id="lightbox-close" 
        class="absolute top-6 right-6 z-60 text-white/80 hover:text-white transition-colors"
        aria-label="Close lightbox"
      >
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Navigation arrows -->
      <button 
        id="lightbox-prev" 
        class="absolute left-6 top-1/2 -translate-y-1/2 text-white/80 hover:text-white transition-colors z-60"
        aria-label="Previous image"
      >
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      
      <button 
        id="lightbox-next" 
        class="absolute right-6 top-1/2 -translate-y-1/2 text-white/80 hover:text-white transition-colors z-60"
        aria-label="Next image"
      >
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>

      <!-- Main content -->
      <div class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 max-h-[90vh]">
        <!-- Media container -->
        <div class="lg:col-span-2 flex items-center justify-center">
          <div class="relative max-w-full max-h-full">
            <img 
              id="lightbox-image" 
              src="" 
              alt="" 
              class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl"
            />
            <video
              id="lightbox-video"
              class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl hidden"
              controls
              preload="metadata"
            >
              <source id="lightbox-video-source" src="" type="video/webm" />
              {currentLang === 'es' ? 'Tu navegador no soporta video WebM.' : 'Your browser does not support WebM video.'}
            </video>
          </div>
        </div>

        <!-- Info sidebar -->
        <div class="lg:col-span-1 text-white space-y-6 overflow-y-auto">
          <div>
            <div id="lightbox-category" class="inline-block px-3 py-1 bg-blue-600 text-white text-sm font-medium rounded-full mb-4"></div>
            <h2 id="lightbox-title" class="text-2xl font-bold mb-4"></h2>
            <p id="lightbox-description" class="text-white/90 leading-relaxed"></p>
          </div>
          
          <!-- Project details -->
          <div class="border-t border-white/20 pt-6">
            <h3 class="text-lg font-semibold mb-3">
              {currentLang === 'es' ? 'Detalles del Proyecto' : 'Project Details'}
            </h3>
            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-white/70">{currentLang === 'es' ? 'Estado:' : 'Status:'}</span>
                <span class="text-green-400 font-medium">{currentLang === 'es' ? 'Completado' : 'Completed'}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-white/70">{currentLang === 'es' ? 'Tipo:' : 'Type:'}</span>
                <span id="lightbox-type" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-white/70">{currentLang === 'es' ? 'Servicio:' : 'Service:'}</span>
                <span class="font-medium">{currentLang === 'es' ? 'Climatización' : 'HVAC'}</span>
              </div>
            </div>
          </div>

          <!-- Media counter -->
          <div class="border-t border-white/20 pt-6">
            <div class="flex items-center justify-between text-sm text-white/70">
              <span id="lightbox-counter">1 / 10</span>
              <span>{currentLang === 'es' ? 'Usar ← → para navegar, Espacio para video' : 'Use ← → to navigate, Space for video'}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .masonry-grid {
    column-gap: 1.5rem;
  }
  
  .masonry-grid > * {
    break-inside: avoid;
    page-break-inside: avoid;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const lightboxItems = document.querySelectorAll('[data-lightbox="projects"]');
    const modal = document.getElementById('lightbox-modal');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    const image = document.getElementById('lightbox-image') as HTMLImageElement;
    const video = document.getElementById('lightbox-video') as HTMLVideoElement;
    const videoSource = document.getElementById('lightbox-video-source') as HTMLSourceElement;
    const title = document.getElementById('lightbox-title');
    const description = document.getElementById('lightbox-description');
    const category = document.getElementById('lightbox-category');
    const type = document.getElementById('lightbox-type');
    const counter = document.getElementById('lightbox-counter');
    
    let currentIndex = 0;
    const mediaItems = Array.from(lightboxItems);
    
    function openLightbox(index: number): void {
      const item = mediaItems[index] as HTMLElement;
      const mediaSrc = item.dataset.src;
      const mediaType = item.dataset.type;
      const mediaTitle = item.dataset.title;
      const mediaDescription = item.dataset.description;
      const mediaCategory = item.dataset.category;
      
      // Hide both media elements first
      if (image) image.classList.add('hidden');
      if (video) video.classList.add('hidden');
      
      if (mediaType === 'video') {
        // Show video player
        if (video) {
          video.classList.remove('hidden');
          if (videoSource && mediaSrc) {
            videoSource.src = mediaSrc;
          }
          video.load(); // Reload the video element
          video.currentTime = 0; // Reset to beginning
        }
      } else {
        // Show image
        if (image && mediaSrc && mediaTitle) {
          image.classList.remove('hidden');
          image.src = mediaSrc;
          image.alt = mediaTitle;
        }
      }
      
      if (title && mediaTitle) title.textContent = mediaTitle;
      if (description && mediaDescription) description.textContent = mediaDescription;
      if (category && mediaCategory) category.textContent = mediaCategory;
      if (type && mediaCategory) type.textContent = mediaCategory;
      if (counter) counter.textContent = `${index + 1} / ${mediaItems.length}`;
      
      if (modal) modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      currentIndex = index;
    }
    
    function closeLightbox(): void {
      // Pause video if playing
      if (video && !video.classList.contains('hidden')) {
        video.pause();
      }
      
      if (modal) modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
    
    function nextMedia(): void {
      // Pause current video if playing
      if (video && !video.classList.contains('hidden')) {
        video.pause();
      }
      
      currentIndex = (currentIndex + 1) % mediaItems.length;
      openLightbox(currentIndex);
    }
    
    function prevMedia(): void {
      // Pause current video if playing
      if (video && !video.classList.contains('hidden')) {
        video.pause();
      }
      
      currentIndex = (currentIndex - 1 + mediaItems.length) % mediaItems.length;
      openLightbox(currentIndex);
    }
    
    // Event listeners
    lightboxItems.forEach((item, index) => {
      item.addEventListener('click', () => openLightbox(index));
    });
    
    if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
    if (nextBtn) nextBtn.addEventListener('click', nextMedia);
    if (prevBtn) prevBtn.addEventListener('click', prevMedia);
    
    // Close on backdrop click
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeLightbox();
      });
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (modal && !modal.classList.contains('hidden')) {
        switch(e.key) {
          case 'Escape':
            closeLightbox();
            break;
          case 'ArrowLeft':
            prevMedia();
            break;
          case 'ArrowRight':
            nextMedia();
            break;
          case ' ': // Spacebar for play/pause video
            e.preventDefault();
            if (video && !video.classList.contains('hidden')) {
              if (video.paused) {
                video.play().catch(console.error);
              } else {
                video.pause();
              }
            }
            break;
        }
      }
    });
    
    // Video event listeners
    if (video) {
      video.addEventListener('loadedmetadata', function() {
        // Video metadata loaded, ready to play
        console.log('Video loaded successfully');
      });
      
      video.addEventListener('error', function(e) {
        console.error('Error loading video:', e);
        // Fallback: hide video and show error message
        if (video) video.classList.add('hidden');
        // You could add an error message element here
      });
    }
  });
</script>