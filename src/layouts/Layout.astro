---
// src/layouts/Layout.astro
import { SEO } from "astro-seo";
import { ViewTransitions } from "astro:transitions";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import Analytics from "@vercel/analytics/astro";
import { siteConfig } from "../config/site";
import { getLanguageFromUrl } from '../i18n/utils';
import LanguagePersistence from '../components/LanguagePersistence.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
  canonicalURL?: string;
}

const currentLang = getLanguageFromUrl(Astro.url);

const {
  title,
  description = typeof siteConfig.description === 'string' ? siteConfig.description : siteConfig.description[currentLang],
  image = "/imagen-social-default.webp",
  canonicalURL = new URL(Astro.url.pathname, 'https://alaska-cool.com').toString(),
} = Astro.props;

const seoTitle = `${title} | ${siteConfig.name} - Aire Acondicionado | Nicaragua`;

const criticalImages = [
  "./industrial_fan_preview.webp",
  "./residencial_ac_preview.webp",
];
---

<!doctype html>
<html lang={currentLang === 'en' ? 'en-US' : 'es-NI'} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="max-age=31536000" />
    <meta http-equiv="Expires" content="31536000" />

    <!-- Geo Meta Tags -->
    <meta name="geo.region" content="NI" />
    <meta name="geo.placename" content="Nicaragua" />
    <meta name="geo.position" content="12.865416;-85.207229" />
    <meta name="ICBM" content="12.865416, -85.207229" />

    <!-- Theme script -->
    <script is:inline>
      (function () {
        function setTheme(newTheme) {
          localStorage.setItem("theme", newTheme);
          document.documentElement.classList.toggle(
            "dark",
            newTheme === "dark",
          );
        }

        const theme =
          localStorage.getItem("theme") ||
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");

        setTheme(theme);

        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            if (!localStorage.getItem("theme")) {
              setTheme(e.matches ? "dark" : "light");
            }
          });

        window.__setTheme = setTheme;
      })();
    </script>

    <!-- View Transitions handler -->
    <script>
      document.addEventListener("astro:after-swap", () => {
        const theme = localStorage.getItem("theme");
        if (theme) {
          document.documentElement.classList.toggle("dark", theme === "dark");
        }
      });
    </script>

    <meta http-equiv="Accept-CH" content="DPR, Width, Viewport-Width" />

    <SEO
      title={seoTitle}
      description={description}
      canonical={canonicalURL}
      noindex={import.meta.env.PROD ? false : true}
      nofollow={false}
      openGraph={{
        basic: {
          title: seoTitle,
          type: "website",
          image: image.startsWith('/') ? `https://alaska-cool.com${image}` : image,
          url: canonicalURL,
        },
        optional: {
          description: description,
          locale: siteConfig.seo.locale[currentLang],
          siteName: siteConfig.name,
        },
        image: {
          alt: "Alaska Cool Nicaragua",
        },
      }}
      twitter={{
        card: "summary_large_image",
        site: "@AlaskaCoolNI",
        creator: "@AlaskaCoolNI",
        title: seoTitle,
        description: description,
        image: image.startsWith('/') ? `https://alaska-cool.com${image}` : image,
        imageAlt: "Alaska Cool Nicaragua",
      }}
      extend={{
        meta: [
          {
            name: "keywords",
            content: siteConfig.seo.keywords[currentLang].join(", "),
          },
          {
            name: "author",
            content: "Alaska Cool",
          },
          {
            name: "generator",
            content: Astro.generator,
          },
          {
            name: "robots",
            content:
              "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",
          },
          {
            name: "google-site-verification",
            content: siteConfig.verification.google,
          },
          {
            name: "facebook-domain-verification",
            content: siteConfig.verification.facebook,
          },
          {
            property: "fb:app_id",
            content: "TU_APP_ID",
          },
          {
            name: "format-detection",
            content: "telephone=no",
          },
        ],
        link: [
          {
            rel: "icon",
            type: "image/png",
            href: "/favicon/favicon-32x32.png",
          },
          {
            rel: "apple-touch-icon",
            href: "/favicon/apple-touch-icon.png",
          },
          {
            rel: "manifest",
            href: "/manifest.json",
          },
          {
            rel: "alternate",
            hreflang: "es-NI",
            href: new URL(Astro.url.pathname, 'https://alaska-cool.com').toString(),
          },
          {
            rel: "alternate",
            hreflang: "en-US",
            href: new URL('/en' + Astro.url.pathname, 'https://alaska-cool.com').toString(),
          },
          {
            rel: "alternate",
            hreflang: "zh-CN",
            href: new URL('/zh' + Astro.url.pathname, 'https://alaska-cool.com').toString(),
          },
          {
            rel: "alternate",
            hreflang: "x-default",
            href: new URL(Astro.url.pathname, 'https://alaska-cool.com').toString(),
          },
        ],
      }}
    />

    <!-- Preload critical images -->
    {
      criticalImages.map((image) => (
        <link rel="preload" as="image" href={image} fetchpriority="high" />
      ))
    }

    <!-- Font Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://api.fontshare.com/v2/css?f[]=cabinet-grotesk@800,500,700,400,300&display=swap"
      rel="stylesheet"
      media="print"
      onload="all"
    />

    <ViewTransitions />

    <style is:inline>
      :root {
        --accent: #1e40af;
        --accent-light: #3b82f6;
        --accent-dark: #1e3a8a;
      }
      html {
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
      }
      .no-js {
        display: none;
      }
    </style>
    

    <!-- Theme TypeScript support -->
    <script>
      declare global {
        interface Window {
          __setTheme?: (theme: string) => void;
        }
      }
    </script>

    <!-- Schema.org markup -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": ["Organization", "LocalBusiness", "HVACBusiness"],
        "@id": "https://alaska-cool.com/#organization",
        name: siteConfig.name,
        alternateName: "Alaska Cool Nicaragua",
        description: siteConfig.description[currentLang],
        url: siteConfig.url,
        logo: {
          "@type": "ImageObject",
          url: "https://alaska-cool.com/logo.webp",
          width: 200,
          height: 200
        },
        image: "https://alaska-cool.com/logo.webp",
        founder: {
          "@type": "Person",
          name: "Alaska Cool"
        },
        foundingDate: "2020",
        address: {
          "@type": "PostalAddress",
          streetAddress: siteConfig.business.address,
          addressLocality: "Managua",
          addressRegion: "Managua",
          addressCountry: "NI",
          areaServed: "Nicaragua"
        },
        geo: {
          "@type": "GeoCoordinates",
          latitude: siteConfig.business.coordinates.latitude,
          longitude: siteConfig.business.coordinates.longitude
        },
        contactPoint: [
          {
            "@type": "ContactPoint",
            telephone: siteConfig.contact.phone,
            contactType: "customer service",
            areaServed: "NI",
            availableLanguage: ["Spanish", "English"]
          },
          {
            "@type": "ContactPoint",
            url: siteConfig.social.whatsapp,
            contactType: "customer support",
            areaServed: "NI",
            availableLanguage: ["Spanish", "English"]
          }
        ],
        email: siteConfig.contact.email,
        telephone: siteConfig.contact.phone,
        priceRange: "$$",
        currenciesAccepted: "NIO,USD",
        paymentAccepted: "Cash, Credit Card, Bank Transfer",
        openingHoursSpecification: {
          "@type": "OpeningHoursSpecification",
          dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
          opens: "08:00",
          closes: "17:00"
        },
        serviceArea: {
          "@type": "GeoCircle",
          geoMidpoint: {
            "@type": "GeoCoordinates",
            latitude: siteConfig.business.coordinates.latitude,
            longitude: siteConfig.business.coordinates.longitude
          },
          geoRadius: "100000"
        },
        hasOfferCatalog: {
          "@type": "OfferCatalog",
          name: "HVAC Services",
          itemListElement: [
            {
              "@type": "Offer",
              itemOffered: {
                "@type": "Service",
                name: "Air Conditioning Installation",
                description: "Professional installation of residential and commercial air conditioning systems"
              }
            },
            {
              "@type": "Offer", 
              itemOffered: {
                "@type": "Service",
                name: "HVAC Maintenance",
                description: "Regular maintenance and repair services for heating, ventilation and air conditioning systems"
              }
            },
            {
              "@type": "Offer",
              itemOffered: {
                "@type": "Service", 
                name: "Commercial Refrigeration",
                description: "Cold room and commercial refrigeration system installation and maintenance"
              }
            }
          ]
        },
        makesOffer: [
          {
            "@type": "Offer",
            itemOffered: {
              "@type": "Product",
              name: "Rheem Air Conditioners",
              brand: "Rheem"
            }
          },
          {
            "@type": "Offer",
            itemOffered: {
              "@type": "Product", 
              name: "TempBlue Air Conditioners",
              brand: "TempBlue"
            }
          },
          {
            "@type": "Offer",
            itemOffered: {
              "@type": "Product",
              name: "ComfortStar Air Conditioners", 
              brand: "ComfortStar"
            }
          }
        ],
        sameAs: [
          siteConfig.social.facebook,
          siteConfig.social.instagram,
          siteConfig.social.whatsapp
        ],
        aggregateRating: {
          "@type": "AggregateRating",
          ratingValue: "4.8",
          reviewCount: "45",
          bestRating: "5",
          worstRating: "1"
        }
      })}
    />

    <!-- RSS Feed -->
    <link 
      rel="alternate" 
      type="application/rss+xml" 
      title={`${siteConfig.name} RSS Feed`} 
      href={`${siteConfig.url}/rss.xml`} 
    />
  </head>
  <body class="bg-white dark:bg-gray-900">
    <LanguagePersistence />
    <Navbar />
    <main class="relative z-10">
      <slot />
    </main>
    <Footer />
    <Analytics />
  </body>
</html>
